<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미수금 조회 프로그램</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 1em; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: 0 auto; background-color: white; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align: center; margin-bottom: 1em;}
        .search-container { margin-bottom: 1.5em; }
        .search-controls { display: flex; gap: 10px; }
        input { flex-grow: 1; padding: 10px; box-sizing: border-box; }
        button { padding: 10px 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 1em; white-space: nowrap; }
        #capture-btn { background-color: #28a745; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; word-wrap: break-word; }
        th { background-color: #f2f2f2; }
        .error { color: red; }

        /* 결과 헤더 및 금액 스타일 */
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        #result-message { font-weight: bold; }
        #total-amount { font-weight: bold; font-size: 1.2em; color: #d93025; }
        
        /* 청구서 스타일 */
        #invoice-title { text-align: center; font-size: 1.8em; font-weight: bold; color: #2c3e50; margin-top: 1.5em; margin-bottom: 0.2em; }
        #seller-name { text-align: center; font-size: 1.2em; color: #333; margin-top: 0; }
        .notice-box { background-color: #f3f8ff; border: 1px solid #b8d6ff; padding: 15px; margin-top: 1.5em; border-radius: 5px; font-size: 14px; line-height: 1.6; }
        .account-number { color: red; font-weight: bold; }
        
        .table-wrapper { overflow-x: auto; margin-top: 1em; }
        #manager-results-container, #pos-results-container { display: none; } /* 결과 컨테이너 기본 숨김 */

        @media (max-width: 768px) {
            body { padding: 0.5em; }
            .container { padding: 1em; }
            h1 { font-size: 1.5em; }
            .search-controls { flex-direction: column; }
            #capture-btn { display: none; }
            table { table-layout: auto; }
            th, td { font-size: 12px; padding: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>미수금 조회 프로그램</h1>
        
        <div class="search-container">
            <h2>담당별 조회</h2>
            <div class="search-controls">
                <input type="text" id="manager-name-input" placeholder="담당명을 입력하세요">
                <button onclick="searchByManager()">담당 조회</button>
            </div>
        </div>

        <div class="search-container">
            <h2>POS코드별 조회</h2>
            <div class="search-controls">
                <input type="text" id="pos-code-input" placeholder="POS코드를 입력하세요">
                <button onclick="searchByPosCode()">POS코드 조회</button>
                <button id="capture-btn" onclick="captureResults()">이미지다운</button>
            </div>
        </div>

        <div id="manager-results-container">
            <h2 id="manager-name-header"></h2>
            <div class="table-wrapper">
                <table id="manager-results-table">
                    <thead>
                        <tr>
                            <th>판매처</th>
                            <th>정산금액 합계</th>
                            <th>상세보기</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="pos-results-container">
            <div id="capture-area">
                <h2 id="invoice-title" style="display: none;">&lt;미수금 청구서&gt;</h2>
                <h3 id="seller-name"></h3>
                <div class="notice-box" id="notice-box" style="display: none;">
                    <strong id="notice-seller-name"></strong>(은)는 주식회사 유모스트와의 거래중 아래와 같은 사유로 미수금이 발생하여 입금을 요청하는 바 , <br>
                    다음의 계좌로 기간 내 입금하여 주시기 바랍니다. <br>
                    <span class="account-number">우리은행 1005-003-519136 주식회사 유모스트</span> &nbsp;&nbsp;// 입금기한 : 미수금공지후 3일이내 입금필수
                </div>
                <div class="result-header">
                    <div id="result-message"></div>
                    <div id="total-amount"></div>
                </div>
                <div class="table-wrapper">
                    <table id="result-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">정산년월</th>
                                <th style="width: 20%;">정산항목</th>
                                <th style="width: 45%;">상세내용</th>
                                <th style="width: 20%; text-align: right;">정산금액</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData;

        // 1. CSV 데이터 로드 및 파싱
        async function loadCSV() {
            if (csvData) return csvData;
            try {
                const response = await fetch('data.csv');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                csvData = parseCSV(text);
                return csvData;
            } catch (error) {
                alert(`파일을 불러올 수 없습니다: ${error.message}`);
                return [];
            }
        }

        function parseCSV(text) {
            const rows = text.trim().split('\n').slice(1);
            return rows.map(row => {
                const columns = row.split(',');
                return {
                    manager: columns[0]?.trim(),
                    posCode: columns[1]?.trim(),
                    seller: columns[2]?.trim(),
                    date: columns[3]?.trim(),
                    item: columns[4]?.trim(),
                    details: columns.slice(5, -1).join(',') || columns[5]?.trim(), // 상세내용에 쉼표가 있을 경우 대비
                    amount: parseInt(columns[columns.length - 1], 10) || 0
                };
            }).filter(row => row.manager && row.posCode);
        }

        // Enter 키로 검색 실행
        document.getElementById('manager-name-input').addEventListener('keyup', (e) => e.key === 'Enter' && searchByManager());
        document.getElementById('pos-code-input').addEventListener('keyup', (e) => e.key === 'Enter' && searchByPosCode());

        // 2. 담당별 조회 기능
        async function searchByManager() {
            const managerName = document.getElementById('manager-name-input').value.trim();
            if (!managerName) {
                alert('담당명을 입력해주세요.');
                return;
            }
            const data = await loadCSV();
            const managerData = data.filter(row => row.manager === managerName);
            if (managerData.length === 0) {
                alert('해당 담당의 데이터가 없습니다.');
                return;
            }
            const aggregatedData = managerData.reduce((acc, row) => {
                if (!acc[row.seller]) {
                    acc[row.seller] = { totalAmount: 0, posCode: row.posCode };
                }
                acc[row.seller].totalAmount += row.amount;
                return acc;
            }, {});
            displayManagerResults(managerName, aggregatedData);
        }
        
        function displayManagerResults(managerName, aggregatedData) {
            const managerContainer = document.getElementById('manager-results-container');
            const posContainer = document.getElementById('pos-results-container');
            const tableBody = document.getElementById('manager-results-table').querySelector('tbody');
            
            document.getElementById('manager-name-header').innerText = `${managerName} 담당 판매처 목록`;
            tableBody.innerHTML = '';

            for (const seller in aggregatedData) {
                const data = aggregatedData[seller];
                const row = tableBody.insertRow();
                row.insertCell(0).innerText = seller;
                row.insertCell(1).innerText = `${data.totalAmount.toLocaleString()}원`;
                
                const detailCell = row.insertCell(2);
                const detailButton = document.createElement('button');
                detailButton.innerText = '상세보기';
                detailButton.onclick = () => {
                    document.getElementById('pos-code-input').value = data.posCode;
                    searchByPosCode(); // POS 코드 조회 함수 자동 실행
                };
                detailCell.appendChild(detailButton);
            }
            managerContainer.style.display = 'block';
            posContainer.style.display = 'none';
        }

        // 3. POS코드별 조회 기능
        async function searchByPosCode() {
            const posCode = document.getElementById('pos-code-input').value.trim();
            if (!posCode) {
                alert('POS코드를 입력해주세요.');
                return;
            }
            const data = await loadCSV();
            const filteredData = data.filter(row => row.posCode === posCode);
            displayPosResults(filteredData);
        }

        function displayPosResults(filteredData) {
            const managerContainer = document.getElementById('manager-results-container');
            const posContainer = document.getElementById('pos-results-container');
            const tableBody = document.querySelector("#result-table tbody");
            const resultMessage = document.getElementById('result-message');
            const totalAmountDiv = document.getElementById('total-amount');
            const invoiceTitle = document.getElementById('invoice-title');
            const sellerNameDiv = document.getElementById('seller-name');
            const noticeBox = document.getElementById('notice-box');
            const noticeSellerName = document.getElementById('notice-seller-name');
            const captureBtn = document.getElementById('capture-btn');

            // 초기화
            tableBody.innerHTML = "";
            resultMessage.innerText = "";
            totalAmountDiv.innerText = "";
            sellerNameDiv.innerText = "";

            if (filteredData.length === 0) {
                resultMessage.innerText = '해당 POS코드의 데이터가 없습니다.';
                invoiceTitle.style.display = 'none';
                noticeBox.style.display = 'none';
                captureBtn.style.display = 'none';
                posContainer.style.display = 'block';
                managerContainer.style.display = 'none';
                return;
            }

            const sellerName = filteredData[0].seller;
            invoiceTitle.style.display = 'block';
            sellerNameDiv.innerText = sellerName;
            noticeSellerName.innerText = sellerName;
            noticeBox.style.display = 'block';
            captureBtn.style.display = 'block';

            resultMessage.innerText = `총 ${filteredData.length}건이 조회되었습니다.`;

            let totalSum = 0;
            filteredData.forEach(item => {
                totalSum += item.amount;
                let row = tableBody.insertRow();
                row.insertCell(0).innerText = item.date;
                row.insertCell(1).innerText = item.item;
                row.insertCell(2).innerText = item.details;
                let amountCell = row.insertCell(3);
                amountCell.innerText = item.amount.toLocaleString();
                amountCell.style.textAlign = 'right';
            });

            totalAmountDiv.innerText = `총 미수금액: ${(totalSum * -1).toLocaleString()}원`;
            
            posContainer.style.display = 'block';
            managerContainer.style.display = 'none';
        }
        
        // 4. 캡쳐 기능
        function captureResults() {
            const captureArea = document.getElementById('capture-area');
            const sellerName = document.getElementById('seller-name').innerText;
            const wrapper = captureArea.querySelector('.table-wrapper');
            const originalMaxHeight = wrapper.style.maxHeight;

            wrapper.style.maxHeight = 'none';
            wrapper.style.overflowX = 'visible';

            html2canvas(captureArea, {
                scale: 2, 
                backgroundColor: "#ffffff",
                useCORS: true,
                windowWidth: captureArea.scrollWidth,
                windowHeight: captureArea.scrollHeight
            }).then(canvas => {
                const image = canvas.toDataURL("image/png", 1.0);
                const link = document.createElement('a');
                link.href = image;
                link.download = `미수금청구서_${sellerName}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                wrapper.style.maxHeight = originalMaxHeight;
                wrapper.style.overflowX = 'auto';
            });
        }
    </script>
</body>
</html>