<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미수금 조회 프로그램</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 1em; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: 0 auto; background-color: white; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align: center; margin-bottom: 1em;}
        .search-container { margin-bottom: 1em; }
        .search-controls { display: flex; gap: 10px; margin-bottom: 10px;}
        input { flex-grow: 1; padding: 10px; box-sizing: border-box; }
        button { padding: 10px 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 1em; white-space: nowrap; }
        #capture-btn { background-color: #28a745; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .result-message { margin-top: 1em; }
        .success { color: green; }
        .error { color: red; }
        .table-wrapper { max-height: 400px; overflow-x: auto; margin-top: 1em;}
        #totalAmountDiv { font-weight: bold; text-align: right; margin-top: 1em;}
        #manager-results-container, #pos-results-container { display: none; } /* Initially hide both containers */
    </style>
</head>
<body>
    <div class="container">
        <h1>미수금 조회 프로그램</h1>

        <!-- 담당자 검색 -->
        <div class="search-container">
            <h2>담당자별 조회</h2>
            <div class="search-controls">
                <input type="text" id="manager-name" placeholder="담당자명을 입력하세요">
                <button onclick="searchByManager()">담당자 조회</button>
            </div>
        </div>

        <!-- POS코드 검색 -->
        <div class="search-container">
            <h2>POS코드별 조회</h2>
            <div class="search-controls">
                <input type="text" id="pos-code" placeholder="POS코드를 입력하세요">
                <button onclick="searchByPosCode()">POS코드 조회</button>
                <button id="capture-btn" onclick="captureResults()">화면 캡쳐</button>
            </div>
        </div>
        
        <!-- 담당자별 결과 -->
        <div id="manager-results-container">
            <h2 id="manager-name-header"></h2>
            <div class="table-wrapper">
                <table id="manager-results-table">
                    <thead>
                        <tr>
                            <th>판매처</th>
                            <th>정산금액 합계</th>
                            <th>상세보기</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- POS코드별 결과 -->
        <div id="pos-results-container">
            <div id="capture-area">
                <h2 id="seller-name"></h2>
                <p id="result-message" class="result-message"></p>
                <div class="table-wrapper">
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th>정산년월</th>
                                <th>정산항목</th>
                                <th>상세내용</th>
                                <th>정산금액</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="totalAmountDiv"></div>
            </div>
        </div>
    </div>

    <script>
        let csvData;

        // CSV 데이터 로드
        async function loadCSV() {
            if (csvData) return csvData;
            try {
                const response = await fetch('data.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                csvData = parseCSV(text);
                return csvData;
            } catch (error) {
                console.error("CSV 로딩 오류:", error);
                document.getElementById('result-message').innerText = `파일을 불러올 수 없습니다: ${error.message}`;
                return [];
            }
        }

        function parseCSV(text) {
            const rows = text.split('\n').slice(1);
            return rows.map(row => {
                const columns = row.split(',');
                return {
                    manager: columns[0]?.trim(),
                    posCode: columns[1]?.trim(),
                    seller: columns[2]?.trim(),
                    date: columns[3]?.trim(),
                    item: columns[4]?.trim(),
                    details: columns[5]?.trim(),
                    amount: parseInt(columns[6], 10) || 0
                };
            }).filter(row => row.manager && row.posCode); // 필수 데이터가 있는 행만 필터링
        }
        
        // 담당자별 조회 함수
        async function searchByManager() {
            const managerName = document.getElementById('manager-name').value.trim();
            if (!managerName) {
                alert('담당자명을 입력해주세요.');
                return;
            }

            const data = await loadCSV();
            const managerData = data.filter(row => row.manager === managerName);

            if (managerData.length === 0) {
                alert('해당 담당자의 데이터가 없습니다.');
                return;
            }

            const aggregatedData = managerData.reduce((acc, row) => {
                if (!acc[row.seller]) {
                    acc[row.seller] = { totalAmount: 0, posCode: row.posCode };
                }
                acc[row.seller].totalAmount += row.amount;
                return acc;
            }, {});

            displayManagerResults(managerName, aggregatedData);
        }

        function displayManagerResults(managerName, aggregatedData) {
            const managerResultsContainer = document.getElementById('manager-results-container');
            const posResultsContainer = document.getElementById('pos-results-container');
            const tableBody = document.getElementById('manager-results-table').querySelector('tbody');
            
            document.getElementById('manager-name-header').innerText = `${managerName} 담당 판매처 목록`;
            tableBody.innerHTML = '';

            for (const seller in aggregatedData) {
                const row = tableBody.insertRow();
                const data = aggregatedData[seller];
                
                row.insertCell(0).innerText = seller;
                row.insertCell(1).innerText = `${data.totalAmount.toLocaleString()}원`;
                
                const detailCell = row.insertCell(2);
                const detailButton = document.createElement('button');
                detailButton.innerText = '상세보기';
                detailButton.onclick = () => {
                    document.getElementById('pos-code').value = data.posCode;
                    searchByPosCode();
                };
                detailCell.appendChild(detailButton);
            }

            managerResultsContainer.style.display = 'block';
            posResultsContainer.style.display = 'none';
        }

        // POS코드별 조회 함수
        async function searchByPosCode() {
            const posCode = document.getElementById('pos-code').value.trim();
            if (!posCode) {
                alert('POS코드를 입력해주세요.');
                return;
            }
            
            const data = await loadCSV();
            const filteredData = data.filter(row => row.posCode === posCode);
            displayPosResults(filteredData);
        }

        function displayPosResults(filteredData) {
            const posResultsContainer = document.getElementById('pos-results-container');
            const managerResultsContainer = document.getElementById('manager-results-container');

            const tableBody = document.getElementById('results-table').querySelector('tbody');
            const resultMessage = document.getElementById('result-message');
            const sellerNameDiv = document.getElementById('seller-name');
            const totalAmountDiv = document.getElementById('totalAmountDiv');

            tableBody.innerHTML = '';
            resultMessage.innerText = '';
            sellerNameDiv.innerText = '';
            totalAmountDiv.innerText = '';

            try {
                if (filteredData.length === 0) {
                    throw new Error('해당 POS코드의 데이터가 없습니다.');
                }
                
                const sellerName = filteredData[0].seller;
                sellerNameDiv.innerText = sellerName;
                
                let totalSum = 0;

                filteredData.forEach(item => {
                    let row = tableBody.insertRow();
                    row.insertCell(0).innerText = item.date;
                    row.insertCell(1).innerText = item.item;
                    row.insertCell(2).innerText = item.details;
                    row.insertCell(3).innerText = item.amount.toLocaleString();
                    totalSum += item.amount;
                });
                
                resultMessage.innerText = `${sellerName} 조회 결과: 총 ${filteredData.length}건`;
                resultMessage.className = 'success';
                totalAmountDiv.innerText = `총 미수금액: ${(totalSum * -1).toLocaleString()}원`;

            } catch (error) {
                console.error("오류 상세 정보:", error);
                resultMessage.innerText = `오류가 발생했습니다: ${error.message}`;
                resultMessage.className = 'error';
            }
            
            posResultsContainer.style.display = 'block';
            managerResultsContainer.style.display = 'none';
        }
        
        function captureResults() {
            const captureArea = document.getElementById('capture-area');
            const sellerName = document.getElementById('seller-name').innerText;
            
            const wrapper = document.querySelector('.table-wrapper');
            wrapper.style.overflowX = 'visible';

            html2canvas(captureArea, {
                scale: 2, 
                backgroundColor: "#ffffff",
                useCORS: true,
                windowWidth: captureArea.scrollWidth,
                windowHeight: captureArea.scrollHeight
            }).then(canvas => {
                const image = canvas.toDataURL("image/png", 1.0);
                const link = document.createElement('a');
                link.href = image;
                link.download = `미수금청구서_${sellerName}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                wrapper.style.overflowX = 'auto';
            });
        }
    </script>
</body>
</html>